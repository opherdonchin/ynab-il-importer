# ynab-il-importer Findings Summary (2026-02-23)

## Scope

This summarizes what we learned while implementing Phase 1 card normalization, testing real files, and analyzing transfer handling across:

- Card exports (`transaction-details_export_*.xlsx`)
- Bank NIS files (`Bankin*.dat`)
- Bank statement export (`תנועות בחשבון 22_2_2026.xls`)
- YNAB register (`Family 2024 as of 2026-02-22 01-42 - Register.csv`)

---

## What Was Implemented

### 1) Card parser now emits unified normalized schema

`src/ynab_il_importer/io_card.py` now outputs normalized fields including:

- `source`, `account_name`, `date`, `charge_date`, `txn_kind`
- `merchant_raw`, `description_raw`, `description_clean`, `description_clean_norm`
- `fingerprint`, `fingerprint_hash`
- `amount_ils`, `currency`

Behavior:

- `txn_kind` is fixed to `card`.
- `date` uses card transaction date (`תאריך עסקה`).
- `charge_date` preserved from `תאריך חיוב`.
- Currency normalization maps `₪` / `ש"ח` / `שח` to `ILS`, uppercases, blanks -> `ILS`.
- Pure empty/footer rows are dropped.

### 2) Pairing remains compatible

`src/ynab_il_importer/pairing.py` for card now prefers:

1. `description_clean`
2. `description_raw`
3. `merchant_raw`

### 3) Test coverage added

- Golden fixture test for card normalization:
  - `tests/test_io_card.py`
  - `tests/fixtures/card/max_sample_input.csv`
  - `tests/fixtures/expected/card_max_sample_normalized.csv`
- Additional tests for account map behavior:
  - `tests/test_account_map.py`

---

## Account Handling Changes (Hardwired)

### 1) Source account extraction

- Card exports: account inferred from column containing `4 ספרות אחרונות...`, normalized to `xNNNN`.
- NIS `.dat` files: account read from final field in each record.

### 2) Mapping file support

Added `src/ynab_il_importer/account_map.py`.

Mapping file:

- `mappings/account_name_map.csv`
- Expected columns:
  - `source` (optional: `card` / `bank`)
  - `source_account`
  - `ynab_account_name`

Rules:

- If mapping file missing: keep source account names.
- If mapping file exists but account not mapped: keep source account names.
- In both cases: emit clear warning listing unmatched accounts.

### 3) CLI changes

- `parse-card` no longer takes `--account-name`.
- `parse-bankin` no longer takes `--account-name`.
- Both rely on extracted account identities + optional mapping file.

---

## Real-Data Observations

## Card files

For `transaction-details_export_1771801521858.xlsx` after fixes:

- Parsed rows: `951`
- Null dates: `0`
- Zero amounts: `0`
- Currency counts: `ILS = 951`

For `transaction-details_export_1771802175492.xlsx`:

- Parsed rows: `476`
- Extracted card accounts seen: `x1950, x7400, x8490, x8980, x9220`

## NIS `.dat` file

For `Bankin fuller.dat`:

- Parsed rows: `120`
- Extracted account seen: `67833011333622`

---

## Seed Account Mapping Table

Generated:

- `mappings/account_name_map_seed.csv`

Contains side-by-side lists:

- `source_account` from real card + bank raw files
- `ynab_account_name` from YNAB export

Current source accounts found:

- `67833011333622`
- `x1950`
- `x7400`
- `x8490`
- `x8980`
- `x9220`

Current YNAB account names found (13 total):

- `Bank Leumi`, `Cash`, `Investments`, `Liya X7195`, `Loan Leumi 45,000 06_2022`,
  `Mortgage`, `Opher X5898`, `Opher x9922`, `Pilates Leumi`, `Planned Liya`,
  `Retirement`, `Unplanned Opher`, `US Money`

---

## Transfer Analysis

Generated combined transfer file:

- `outputs/transfer_transactions_combined.csv`

Contents:

- Transfer rows from NIS and XLS sources merged with shared keys.
- `present_in_nis` / `present_in_xls` flags.
- Rich NIS fields (`nis_description_raw`, account tokens in text).
- XLS fields (`xls_ref`, `xls_description_raw`, value-date/outflow/inflow).

Counts:

- Total rows: `62`
- Present in NIS: `18`
- Present in XLS: `50`
- Present in both: `6`
- NIS-only: `12`
- XLS-only: `44`

Duplicate risk in combined file by `(date, amount_ils)`:

- Unique keys: `61` over `62` rows
- Only one duplicated key:
  - `2025-05-11`, `5000.0` (2 rows, XLS-only, different refs)

Date overlap conclusion:

- NIS transfer date window: `2026-01-23` to `2026-02-20`
- `44/44` XLS-only rows are outside NIS date range (100% date coverage explanation)

Matched-row detail (XLS vs NIS):

- For the 6 matched rows, XLS adds no stronger identifying data:
  - `xls_ref == nis_ref`
  - `xls_value_date == posting_date`
  - XLS description is generic; NIS descriptions are richer.

---

## YNAB Transfer Matching Attempt

Generated:

- `outputs/nis_to_ynab_transfer_matches.csv`
- `outputs/transfer_payee_map_candidates.csv`
- `outputs/transfer_match_summary.txt`

Method:

- YNAB transfer rows identified by payee pattern `Transfer : {Account}`.
- Matched NIS transfers to YNAB transfers on exact `(date, amount_ils)`.

Result:

- NIS transfer rows: `18`
- YNAB transfer rows: `421`
- Exact date+amount matches: `0`

Interpretation:

- Not enough YNAB overlap in NIS window:
  - Only `5` YNAB rows exist in the NIS transfer date range.

---

## Fingerprinting Findings for Transfers

Current behavior:

- Transfer fingerprint inputs come from `description_clean` (currently merchant-like extraction).
- NIS account-number tokens embedded in raw text are **not** currently part of fingerprint inputs.

Observed from NIS transfer rows:

- `17/18` rows include an account token in raw description (strong signal).
- Transfer channel markers exist (`העברה דיגיטל`, `העברה תוך יומי`, `העברה עצמית`, `הפועלים-ביט`, `אינטרנט`).
- Free-text purpose prefixes are mostly unique/noisy (17 unique over 18 rows).

Implication:

- There is strong additional transfer identity signal in NIS raw descriptions that current fingerprinting does not use.

---

## Recommendations

## 1) Finalize account mapping before further pairing/bootstrap

1. Fill `mappings/account_name_map.csv` from the seed table.
2. Keep one row per source account -> YNAB account.
3. Re-run parsers and ensure warnings are empty (or expected).

## 2) Treat NIS as authoritative for transfer-rich detail

1. For overlapping transfer rows, prefer NIS description/reference fields.
2. Use XLS mainly for historical coverage outside NIS window.

## 3) Add transfer-aware normalized fields (without breaking existing fingerprint v1 yet)

Add non-breaking columns (proposal):

- `transfer_channel` (e.g., digital/internal/bit/internet)
- `transfer_account_token_raw` (if present)
- `transfer_counterparty_raw` (extracted name)

This enables analysis and future rules without changing current global fingerprint behavior immediately.

## 4) Decide transfer mapping key strategy explicitly

Options:

1. Keep global fingerprint unchanged; use transfer-specific rule keys (new columns) in payee_map.
2. Introduce a transfer-specific fingerprint variant key (versioned), while preserving existing v1.

Recommendation:

- Start with option 1 for Milestone 1 safety.
- Add versioned fingerprint only if needed after observing ambiguity.

## 5) Re-run YNAB transfer bootstrap with proper overlap

1. Export YNAB transactions for the same accounts/date window as NIS transfer data.
2. Rebuild transfer candidate mapping outputs.
3. Validate that transfer payee mapping defaults resolve cleanly.

## 6) Plan updates to capture this work

In `documents/plan.md`:

1. Add a dedicated subtask for account identity normalization + mapping file policy.
2. Add transfer-specific analysis and matching task (NIS-first detail source).
3. Add transfer-aware mapping bootstrap criteria and validation checks.

---

## Suggested Immediate Next Steps

1. Populate `mappings/account_name_map.csv` from `mappings/account_name_map_seed.csv`.
2. Re-parse card + bankin with mappings in place and verify account alignment with YNAB.
3. Export an overlapping YNAB date range and rerun transfer match/candidate generation.
4. Decide whether to include transfer account tokens in mapping keys for transfer transactions.
